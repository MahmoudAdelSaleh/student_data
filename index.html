<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة استخراج بيانات الطلاب</title>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #000000;
            --text-color: #f5f5f5;
            --border-color: #555555;
            --hover-color: #004494;
            --success-color: #28a745;
            --comment-bg: #2a2a2a;
        }
        body {
            font-family: 'Tahoma', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            text-align: center;
        }
        
        /* تنسيقات الماركوي المحدثة */
        .marquee-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #1c1c1c;
            padding: 12px 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            height: 50px;
        }
        .marquee-container marquee {
            white-space: nowrap;  
        }
        .marquee-container a {
            color: white;
            text-decoration: none;
            font-size: 1.5em;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .whatsapp-icon {
            width: 1em; 
            height: 1em; 
            fill: #25D366; 
            vertical-align: middle;
        }
        
        /* الحاوية الرئيسية */
        .main-content-wrapper {
            padding-top: 75px;
            padding-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            min-height: calc(100vh - 75px);
        }
        
        .container {
            background-color: #111;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 25px,
                    rgba(192, 192, 192, 0.1) 25px,
                    rgba(192, 192, 192, 0.1) 27px
                ),
                linear-gradient(
                    160deg,
                    #000000 0%,
                    #1c1c1c 40%,
                    #4d4d4d 100%
                );
            color: var(--text-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.5);
            max-width: 800px;
            width: 90%;
            border-top: 5px solid var(--primary-color);
            margin: 0 auto;
        }
        
        h1, h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            cursor: default;
        }
        p, li {
            line-height: 1.8;
            font-size: 16px;
        }
        .instructions {
            background-color: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            margin-top: 20px;
        }
        .instructions ol {
            text-align: right;
            display: inline-block;
            padding-right: 40px;
        }
        .bookmarklet-link {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
            cursor: move;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }
        .bookmarklet-link:hover {
            background-color: var(--hover-color);
            transform: scale(1.05);
        }

        /* --- CSS for Counter and Comments --- */
        .visitor-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            margin: 20px 0;
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 8px;
            font-size: 1.1em;
            border-left: 5px solid var(--success-color);
        }
        .visitor-counter svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
        }
        
        .comments-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .comment-form input, .comment-form textarea {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: #333;
            color: var(--text-color);
            font-family: 'Tahoma', sans-serif;
            font-size: 16px;
        }
        .comment-form input::placeholder, .comment-form textarea::placeholder {
            color: #aaa;
        }
        .comment-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        .comment-form button {
            padding: 12px 20px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .comment-form button:hover {
            background-color: #218838;
        }

        .comments-container {
            text-align: right;
        }
        .comment-display {
            background-color: var(--comment-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-right: 4px solid var(--primary-color);
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .comment-author {
            font-weight: bold;
            color: #4dabf7; /* Light blue for author name */
        }
        .comment-date {
            font-size: 0.8em;
            color: #aaa;
        }
        .comment-body {
            white-space: pre-wrap; /* Preserve line breaks in comments */
            word-wrap: break-word;
        }

        /* --- START: New CSS for instructions typewriter --- */
        .instructions ol li {
            position: relative;
        }
        .instructions ol li.typing::after {
            content: '▋'; /* Using a block character for the cursor */
            color: var(--text-color);
            animation: blink-cursor 1s infinite;
            position: absolute;
            left: -5px; /* Position cursor to the left for RTL text */
            top: 0;
        }
        @keyframes blink-cursor {
            50% { opacity: 0; }
        }
        /* --- END: New CSS --- */


        /* Responsive improvements */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px 15px;
            }
            .marquee-container { height: 40px; }
            .marquee-container a { font-size: 1.3em; }
            .main-content-wrapper { padding-top: 60px; }
            .bookmarklet-link { padding: 12px 20px; font-size: 16px; }
            .instructions ol { padding-right: 20px; }
        }
    </style>
</head>
<body>
    <div class="marquee-container">
        <marquee behavior="scroll" direction="right" scrollamount="6">
            <a href="https://wa.me/201552402912" target="_blank" rel="noopener noreferrer">
                <svg class="whatsapp-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.04 2.01c-5.52 0-9.99 4.47-9.99 9.99 0 1.77.46 3.45 1.28 4.92L2.01 22l5.25-1.37c1.42.75 3.02 1.2 4.78 1.2h.01c5.52 0 9.99-4.47 9.99-9.99s-4.47-9.99-9.99-9.99zM12.04 20.14h-.01c-1.6 0-3.13-.38-4.49-1.07l-.32-.19-3.33.87.89-3.25-.21-.34c-.79-1.28-1.21-2.78-1.21-4.34 0-4.41 3.58-7.99 7.99-7.99 2.21 0 4.21.86 5.66 2.31 1.45 1.45 2.31 3.45 2.31 5.66-.01 4.41-3.59 7.99-8 7.99zm4.83-5.9c-.27-.13-1.58-.78-1.82-.87-.25-.09-.43-.13-.61.13-.19.27-.69.87-.85 1.04-.16.17-.32.19-.59.06-.27-.13-1.15-.42-2.19-1.35-.81-.72-1.36-1.61-1.52-1.88-.16-.27-.02-.42.12-.55.12-.12.27-.3.4-.45.13-.15.17-.25.25-.42.09-.17.04-.31-.02-.44s-.61-1.45-.83-1.98c-.22-.52-.45-.45-.61-.46-.15-.01-.32-.01-.49-.01-.17 0-.44.06-.67.31-.23.25-.87.85-.87 2.07 0 1.22.89 2.4 1.02 2.56.12.17 1.76 2.68 4.27 3.77 2.51 1.08 2.51.72 2.96.69.45-.03 1.58-.64 1.8-1.25.23-.61.23-1.13.16-1.25-.07-.12-.25-.19-.52-.32z"/></svg>
                <span id="marquee-text">مع تحيات استاذ/ محمود عادل صالح</span>
            </a>
        </marquee>
    </div>

    <div class="main-content-wrapper">
        <div class="container">
            <header>
                <h1 id="main-title">أداة استخراج بيانات التلميذ</h1>
                <h2 id="sub-title">مع تحيات استاذ/ محمود عادل صالح</h2>
            </header>

            <main>
                <section id="bookmarklet">
                    <h2>هيا : استعد لتلقي بيانات تلاميذ مدرستك صفا صفا (Bookmarklet)</h2>
                    <div class="instructions">
                        <p><strong>لا تنسى :</strong> اسحب وأفلت الزر التالي في شريط الإشارات المرجعية (Bookmarks Bar).</p>
                        <div style="text-align: center; margin: 20px 0;">
                            <a class="bookmarklet-link" href="javascript:(async function(){const s='.paginate_button.next:not(.disabled)';let d=[];function f1(){const t=document.querySelector('table');if(!t)return;const n=t.querySelectorAll('tr');if(d.length===0){const t=Array.from(n[0].querySelectorAll('th')).map(t=>t.innerText.trim());d.push(t)}for(let t=1;t<n.length;t++){const e=Array.from(n[t].querySelectorAll('td')).map(t=>t.innerText.trim());e.length>0&&d.push(e)}}function f2(t){const e='\uFEFF';let n=t.map(t=>t.map(t=>`%22${String(t).split('%22').join('%22%22')}%22`).join(',')).join('\n');const o=new Blob([e+n],{type:'text/csv;charset=utf-8;'});const r=document.createElement('a'),a=URL.createObjectURL(o);r.setAttribute('href',a),r.setAttribute('download','student_data.csv'),r.style.visibility='hidden',document.body.appendChild(r),r.click(),document.body.removeChild(r)}async function f3(){for(;;){f1();const t=document.querySelector(s);if(t){t.click();await new Promise(t=>setTimeout(t,2e3))}else break}f2(d)}f3()})();">📊 استخراج البيانات</a>
                        </div>
                         <p><strong>كيفية الاستخدام:</strong></p>
                         <ol>
                             <li> اذهب الى صفحة بيانات التلميذ-تبويب نقل الملف الإلكتروني-تسجيل طلب نقل -بحث عن كود-اختر صف </li>
                             <li>اضغط على زر "📊 استخراج البيانات " الذي وضعته في شريط الإشارات.</li>
                             <li>انتظر حتى يتم تحميل الملف تلقائياً.</li>
                         </ol>
                    </div>
                </section>
                
                <!-- Visitor Counter -->
                <div class="visitor-counter">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span>إجمالي الزوار: <strong id="visitor-count-number">...</strong></span>
                </div>

                <!-- Comments Section -->
                <section class="comments-section" id="comments">
                    <h2>شاركنا رأيك أو استفسارك ✏️</h2>
                    <form id="comment-form" class="comment-form">
                        <input type="text" id="comment-name" placeholder="اسمك (اختياري)">
                        <textarea id="comment-message" placeholder="اكتب تعليقك هنا..." required></textarea>
                        <button type="submit">إرسال التعليق</button>
                    </form>
                    <div id="comments-container" class="comments-container">
                        <!-- Comments will be loaded here dynamically -->
                    </div>
                </section>

            </main>
        </div>
    </div>
    
    <!-- Use type="module" for modern Firebase SDK -->
    <script type="module">
        // Import functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, push, child, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // --- Rainbow Text Effect Script ---
        function applyRainbowColors(element) {
            if (!element || !element.innerText) return;
            const words = element.innerText.split(' ');
            element.innerHTML = '';
            let wordIndex = 0;
            words.forEach((word, index) => {
                if (word.trim() !== '') {
                    const wordSpan = document.createElement('span');
                    wordSpan.innerText = word;
                    const hue = (wordIndex * 35) % 360; 
                    wordSpan.style.color = `hsl(${hue}, 90%, 50%)`;
                    wordSpan.style.display = 'inline-block';
                    wordSpan.style.transition = 'transform 0.2s ease-in-out';
                    wordSpan.style.cursor = 'pointer';
                    wordSpan.addEventListener('mouseenter', () => wordSpan.style.transform = 'scale(1.2)');
                    wordSpan.addEventListener('mouseleave', () => wordSpan.style.transform = 'scale(1)');
                    element.appendChild(wordSpan);
                    wordIndex++;
                }
                if (index < words.length - 1) {
                    element.appendChild(document.createTextNode(' '));
                }
            });
        }

        // --- START: New Typewriter function for instructions ---
        async function typeInstructions() {
            const steps = document.querySelectorAll('.instructions ol li');
            const lines = Array.from(steps).map(el => el.innerHTML); // Store original text

            // Clear all list items to start the effect
            steps.forEach(el => el.innerHTML = '');

            const delay = ms => new Promise(res => setTimeout(res, ms));

            for (let i = 0; i < steps.length; i++) {
                const currentLine = steps[i];
                currentLine.classList.add('typing'); // Add cursor
                
                const text = lines[i];
                // Type out the text character by character
                for (let j = 0; j < text.length; j++) {
                    currentLine.innerHTML = text.substring(0, j + 1);
                    await delay(120); // Typing speed
                }
                
                currentLine.classList.remove('typing'); // Remove cursor after finishing
                await delay(2000); // Pause before starting the next line
            }
        }
        // --- END: New Typewriter function ---


        // --- Firebase Logic ---
        const firebaseConfig = {
            apiKey: "AIzaSyDSJokERBN7HMjUBxVUYhl3q8Nrl3lc0rA",
            authDomain: "student-data-b0538.firebaseapp.com",
            databaseURL: "https://student-data-b0538-default-rtdb.firebaseio.com",
            projectId: "student-data-b0538",
            storageBucket: "student-data-b0538.appspot.com",
            messagingSenderId: "817668351231",
            appId: "1:817668351231:web:28f028964244cf039dd8ca",
            measurementId: "G-8YY5KMH9DL"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Visitor Counter Logic
        const visitorCountRef = ref(database, 'visitors/count');
        const visitorCountElement = document.getElementById('visitor-count-number');
        runTransaction(visitorCountRef, (currentCount) => (currentCount || 0) + 1);
        onValue(visitorCountRef, (snapshot) => {
            if (visitorCountElement) visitorCountElement.textContent = snapshot.val();
        });

        // Comments Logic
        const commentForm = document.getElementById('comment-form');
        const commentsContainer = document.getElementById('comments-container');
        const commentsRef = ref(database, 'comments');

        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('comment-name');
            const messageInput = document.getElementById('comment-message');
            let name = nameInput.value.trim() || `زائر رقم ${Math.floor(Math.random() * 1000)}`;
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('الرجاء كتابة تعليق!');
                return;
            }
            
            push(commentsRef, {
                author: name,
                text: message,
                timestamp: new Date().toISOString()
            });
            nameInput.value = '';
            messageInput.value = '';
        });

        // Fetch and display existing comments
        get(child(commentsRef, '/')).then((snapshot) => {
            if (snapshot.exists()) {
                commentsContainer.innerHTML = '';
                const comments = snapshot.val();
                const commentKeys = Object.keys(comments).reverse(); // Newest first
                commentKeys.forEach(key => displayComment(comments[key]));
            }
        });

        function displayComment(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-display';
            const commentDate = new Date(comment.timestamp).toLocaleString('ar-EG');
            commentDiv.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${comment.author}</span>
                    <span class="comment-date">${commentDate}</span>
                </div>
                <p class="comment-body">${comment.text}</p>
            `;
            commentsContainer.appendChild(commentDiv);
        }

        // Apply effects after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Apply rainbow effect to specific elements, excluding the list items
            const elementsToColor = document.querySelectorAll('#main-title, #sub-title, #bookmarklet h2, .instructions p, #marquee-text, #comments h2');
            elementsToColor.forEach(applyRainbowColors);

            // Start the typewriter effect for the instruction list
            typeInstructions();
        });

    </script>
</body>
</html>

